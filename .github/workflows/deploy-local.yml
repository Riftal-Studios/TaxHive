name: Deploy Local Development

on:
  workflow_dispatch:

env:
  REGISTRY: ghcr.io

jobs:
  deploy-local:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Deploy to local development
        run: |
          echo "Starting local deployment..."
          
          # Export all environment variables (mimicking production deploy.yml)
          export POSTGRES_USER='${{ secrets.POSTGRES_USER }}'
          export POSTGRES_PASSWORD='${{ secrets.POSTGRES_PASSWORD }}'
          export POSTGRES_DB='${{ secrets.POSTGRES_DB }}'
          export REDIS_PASSWORD='${{ secrets.REDIS_PASSWORD }}'
          export REDIS_URL="redis://:${REDIS_PASSWORD}@redis:6379"
          export NEXTAUTH_URL='${{ vars.NEXTAUTH_URL }}'
          export NEXTAUTH_SECRET='${{ secrets.NEXTAUTH_SECRET }}'
          export EMAIL_PROVIDER='${{ vars.EMAIL_PROVIDER }}'
          export EMAIL_FROM='${{ vars.EMAIL_FROM }}'
          export AWS_SES_SMTP_USER='${{ secrets.AWS_SES_SMTP_USER }}'
          export AWS_SES_SMTP_PASSWORD='${{ secrets.AWS_SES_SMTP_PASSWORD }}'
          export AWS_SES_REGION='${{ vars.AWS_SES_REGION }}'
          export AWS_SES_ACCESS_KEY_ID='${{ secrets.AWS_SES_ACCESS_KEY_ID }}'
          export AWS_SES_SECRET_ACCESS_KEY='${{ secrets.AWS_SES_SECRET_ACCESS_KEY }}'
          export AWS_ACCESS_KEY_ID='${{ secrets.AWS_ACCESS_KEY_ID }}'
          export AWS_SECRET_ACCESS_KEY='${{ secrets.AWS_SECRET_ACCESS_KEY }}'
          export AWS_REGION='${{ vars.AWS_REGION }}'
          export AWS_S3_BUCKET='${{ vars.AWS_S3_BUCKET }}'
          export RBI_API_KEY='${{ secrets.RBI_API_KEY }}'
          export EXCHANGE_RATE_API_KEY='${{ secrets.EXCHANGE_RATE_API_KEY }}'
          export CRON_SECRET='${{ secrets.CRON_SECRET }}'
          export CLOUDFLARE_TUNNEL_TOKEN='${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}'
          
          # Stop existing containers
          docker compose -f docker/docker-compose.local.yml down
          
          # Start all services (environment variables will be passed through)
          docker compose -f docker/docker-compose.local.yml up -d
          
          # Wait for services to be healthy
          echo "Waiting for services to be healthy..."
          sleep 10
          
          # Check container status
          docker compose -f docker/docker-compose.local.yml ps
          
          # Run migrations
          echo "Running database migrations..."
          docker compose -f docker/docker-compose.local.yml exec -T app npx prisma migrate deploy
          
          # Check logs
          echo "Checking service logs..."
          docker compose -f docker/docker-compose.local.yml logs --tail 20
          
          # Test the deployment
          echo "Testing dev.gsthive.com..."
          curl -I https://dev.gsthive.com || true
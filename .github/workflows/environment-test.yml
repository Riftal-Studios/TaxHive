name: Test Environment Secrets

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: true
        type: choice
        options:
          - production
          - staging

jobs:
  test-secrets:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Test environment configuration
        run: |
          echo "Testing ${{ github.event.inputs.environment }} environment"
          echo "=================================="
          
          # Test required secrets exist (without exposing values)
          check_secret() {
            if [ -z "$2" ]; then
              echo "❌ $1 is not set"
              return 1
            else
              echo "✅ $1 is configured (length: ${#2})"
              return 0
            fi
          }
          
          echo "Checking VPS configuration..."
          echo "VPS_HOST: ${{ vars.VPS_HOST }}"
          echo "VPS_USER: ${{ vars.VPS_USER }}"
          echo "VPS_PORT: ${{ vars.VPS_PORT }}"
          check_secret "VPS_SSH_KEY" "${{ secrets.VPS_SSH_KEY }}"
          
          echo -e "\nChecking database secrets..."
          check_secret "POSTGRES_PASSWORD" "${{ secrets.POSTGRES_PASSWORD }}"
          check_secret "REDIS_PASSWORD" "${{ secrets.REDIS_PASSWORD }}"
          
          echo -e "\nChecking auth secrets..."
          check_secret "NEXTAUTH_SECRET" "${{ secrets.NEXTAUTH_SECRET }}"
          check_secret "CRON_SECRET" "${{ secrets.CRON_SECRET }}"
          
          echo -e "\nChecking email secrets..."
          check_secret "EMAIL_SERVER" "${{ secrets.EMAIL_SERVER }}"
          check_secret "SMTP_USER" "${{ secrets.SMTP_USER }}"
          check_secret "SMTP_PASSWORD" "${{ secrets.SMTP_PASSWORD }}"
          
          echo -e "\nChecking API secrets..."
          check_secret "EXCHANGE_RATE_API_KEY" "${{ secrets.EXCHANGE_RATE_API_KEY }}"
          check_secret "CLOUDFLARE_TUNNEL_TOKEN" "${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}"
          
          echo -e "\nChecking variables..."
          echo "POSTGRES_USER: ${{ vars.POSTGRES_USER }}"
          echo "POSTGRES_DB: ${{ vars.POSTGRES_DB }}"
          echo "NEXTAUTH_URL: ${{ vars.NEXTAUTH_URL }}"
          echo "EMAIL_FROM: ${{ vars.EMAIL_FROM }}"
          echo "SMTP_HOST: ${{ vars.SMTP_HOST }}"
          echo "SMTP_PORT: ${{ vars.SMTP_PORT }}"
          
          echo -e "\n=================================="
          echo "Environment test complete!"
          
      - name: Test VPS connection
        continue-on-error: true
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ vars.VPS_HOST }}
          username: ${{ vars.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ vars.VPS_PORT }}
          script: |
            echo "✅ SSH connection successful!"
            echo "Server info:"
            uname -a
            docker --version || echo "Docker not installed"
            docker-compose --version || echo "Docker Compose not installed"
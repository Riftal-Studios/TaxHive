// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  password      String?   // Hashed password
  name          String?
  gstin         String?   // GST Identification Number
  pan           String?   // PAN Number
  address       String?
  onboardingCompleted Boolean @default(false)
  onboardingStep String?  // Current step: profile, client, lut, invoice, complete
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts Account[]
  sessions Session[]
  clients  Client[]
  invoices Invoice[]
  luts     LUT[]
  emailHistory EmailHistory[]
  otps     OTP[]
  gstReturns GSTReturn[]
  gstReconciliations GSTReconciliation[]
  vendors Vendor[]
  purchaseInvoices PurchaseInvoice[]
  creditNotes CreditNote[]
  debitNotes DebitNote[]
  itcRegisters ITCRegister[]
  recurringInvoices RecurringInvoice[]
  subscriptions Subscription[]
  advanceReceipts AdvanceReceipt[]
  tdsConfiguration TDSConfiguration?
  tdsDeductions TDSDeduction[]
  tdsPayments TDSPayment[]
  tdsCertificates TDSCertificate[]
  tdsReturns TDSReturn[]
  eInvoiceConfig EInvoiceConfig?
  eInvoices EInvoice[]
  ewayBills EWayBill[]
  clientPortalAccesses ClientPortalAccess[]
  
  // RCM Relations
  rcmTransactions RCMTransaction[]
  foreignSuppliers ForeignSupplier[]
  
  // Approval Workflow Relations
  approvalRoles ApprovalRole[]
  approvalRules ApprovalRule[]
  approvalWorkflows ApprovalWorkflow[]
  approvalDelegations ApprovalDelegation[] @relation("DelegatedToUser")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Client {
  id          String   @id @default(cuid())
  userId      String
  name        String
  email       String
  company     String?
  address     String
  country     String
  phone       String?
  taxId       String? // Foreign tax ID if applicable
  gstin       String? // GSTIN for domestic B2B clients
  stateCode   String? // State code for domestic B2C clients (place of supply)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  invoices Invoice[]
  recurringInvoices RecurringInvoice[]
  subscriptions Subscription[]
  advanceReceipts AdvanceReceipt[]
  portalAccess ClientPortalAccess?
  paymentSubmissions ClientPaymentSubmission[]
  portalNotifications ClientPortalNotification[]

  @@index([userId])
}

model Invoice {
  id             String        @id @default(cuid())
  userId         String
  clientId       String
  invoiceNumber  String        @unique // Format: FY23-24/001
  invoiceDate    DateTime
  dueDate        DateTime
  status         String        @default("DRAFT")
  
  // Invoice Type
  invoiceType    String        @default("EXPORT") // EXPORT, DOMESTIC_B2B, DOMESTIC_B2C
  
  // GST Compliance Fields
  placeOfSupply  String        @default("Outside India (Section 2-6)")
  serviceCode    String        // HSN/SAC code
  lutId          String?       // Reference to LUT (for exports)
  buyerGSTIN     String?       // Buyer's GSTIN for B2B invoices
  
  // Export-specific fields for GSTR-1
  portCode       String?       // Port code for exports
  shippingBillNo String?       // Shipping bill number
  shippingBillDate DateTime?   // Shipping bill date
  
  // Financial Details
  currency       String        @default("USD")
  exchangeRate   Decimal
  exchangeSource String        // RBI/Fallback API
  subtotal       Decimal
  
  // GST Fields for Domestic Invoices
  taxableAmount  Decimal       @default(0)
  cgstRate       Decimal       @default(0)
  sgstRate       Decimal       @default(0)
  igstRate       Decimal       @default(0)
  cgstAmount     Decimal       @default(0)
  sgstAmount     Decimal       @default(0)
  igstAmount     Decimal       @default(0)
  totalGSTAmount Decimal       @default(0)
  
  totalAmount    Decimal
  totalInINR     Decimal
  
  // Payment Status
  paymentStatus  String        @default("UNPAID") // UNPAID, PARTIALLY_PAID, PAID
  amountPaid     Decimal       @default(0)
  advanceAdjusted Decimal      @default(0) // Amount adjusted from advance receipts
  balanceDue     Decimal       @default(0)
  
  // Additional Info
  description    String?
  paymentTerms   String?
  bankDetails    String?
  notes          String?
  
  // Recurring Invoice Reference
  recurringInvoiceId String?
  
  // PDF Storage
  pdfUrl         String?
  pdfStatus      String?   @default("pending") // pending, generating, completed, failed
  pdfError       String?   // Error message if generation failed
  pdfGeneratedAt DateTime? // When PDF was last successfully generated
  pdfJobId       String?   // Queue job ID for tracking
  
  // Public access fields
  publicAccessToken String?   @unique
  tokenExpiresAt    DateTime?
  
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  client      Client        @relation(fields: [clientId], references: [id])
  lut         LUT?          @relation(fields: [lutId], references: [id])
  lineItems   InvoiceItem[]
  payments    Payment[]
  emailHistory EmailHistory[]
  creditNotes CreditNote[]
  debitNotes  DebitNote[]
  recurringInvoice RecurringInvoice? @relation(fields: [recurringInvoiceId], references: [id])
  advanceAdjustments AdvanceAdjustment[]
  eInvoice    EInvoice?
  paymentSubmissions ClientPaymentSubmission[]
  portalNotifications ClientPortalNotification[]
  
  // Approval Workflow Relations
  approvalWorkflow ApprovalWorkflow?

  @@index([userId])
  @@index([clientId])
  @@index([status])
  @@index([paymentStatus])
  @@index([recurringInvoiceId])
}

model InvoiceItem {
  id          String  @id @default(cuid())
  invoiceId   String
  description String
  quantity    Decimal
  rate        Decimal
  amount      Decimal
  serviceCode String  // HSN/SAC code
  uqc         String? // Unit of Quantity Code for GST (e.g., NOS, KGS, MTR)
  
  // GST fields for domestic invoices
  gstRate     Decimal @default(0) // Total GST rate (0%, 5%, 12%, 18%, 28%)
  cgstAmount  Decimal @default(0)
  sgstAmount  Decimal @default(0)
  igstAmount  Decimal @default(0)

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

model Payment {
  id            String   @id @default(cuid())
  invoiceId     String
  amount        Decimal  // Amount client sent (Y in the payment flow)
  currency      String
  paymentDate   DateTime
  paymentMethod String
  reference     String?
  notes         String?
  
  // Payment flow details
  amountReceivedBeforeFees Decimal? // Amount before platform fees (Z in the flow)
  platformFeesInCurrency   Decimal? // Platform fees in original currency (Y - Z)
  
  // Bank credit details
  creditedAmount     Decimal? // Actual amount credited to bank in INR
  actualExchangeRate Decimal? // Exchange rate applied (INR per foreign currency unit)
  bankChargesInr     Decimal? // Bank charges in INR if any
  fircNumber         String?  // FIRC document number
  fircDate           DateTime? // FIRC issue date
  fircDocumentUrl    String?  // URL to uploaded FIRC document
  
  createdAt     DateTime @default(now())

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  clientSubmissions ClientPaymentSubmission[]

  @@index([invoiceId])
  @@index([fircNumber])
}

model LUT {
  id         String    @id @default(cuid())
  userId     String
  lutNumber  String
  lutDate    DateTime
  validFrom  DateTime
  validTill  DateTime
  isActive   Boolean   @default(true)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  invoices Invoice[]
  recurringInvoices RecurringInvoice[]

  @@index([userId])
  @@index([isActive])
}

model ExchangeRate {
  id         String   @id @default(cuid())
  currency   String
  rate       Decimal
  source     String   // RBI/exchangerate-api.com/Manual
  date       DateTime
  createdAt  DateTime @default(now())

  @@unique([currency, date])
  @@index([currency])
  @@index([date])
}

model EmailHistory {
  id         String   @id @default(cuid())
  userId     String
  invoiceId  String?
  type       String   // invoice, payment-reminder, lut-expiry, payment-received
  to         String
  cc         String?
  bcc        String?
  subject    String
  template   String
  messageId  String
  status     String   // SENT, FAILED, BOUNCED
  sentAt     DateTime
  createdAt  DateTime @default(now())

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  invoice Invoice? @relation(fields: [invoiceId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([invoiceId])
  @@index([type])
  @@index([status])
  @@index([sentAt])
}

// InvoiceStatus values: DRAFT, SENT, PAID, PARTIALLY_PAID, OVERDUE, CANCELLED
// PaymentStatus values: UNPAID, PARTIALLY_PAID, PAID

model OTP {
  id        String   @id @default(cuid())
  userId    String?  // Optional for signup OTPs
  email     String
  code      String
  purpose   String   // SIGNUP, PASSWORD_RESET, etc.
  expiresAt DateTime
  attempts  Int      @default(0)
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())
  
  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([email])
  @@index([code])
  @@index([expiresAt])
}

// GST Return Management Models

model GSTReturn {
  id            String    @id @default(cuid())
  userId        String
  returnType    String    // 'GSTR1' | 'GSTR3B' | 'GSTR2A' | 'GSTR9'
  period        String    // 'MM-YYYY' for monthly, 'FY-YYYY' for annual
  financialYear String    // 'FY24-25'
  month         Int?      // 1-12 for monthly returns
  quarter       String?   // 'Q1', 'Q2', 'Q3', 'Q4' for quarterly
  
  // Filing Status
  filingStatus  String    @default("DRAFT") // 'DRAFT' | 'READY' | 'FILED' | 'AMENDED'
  filingDate    DateTime?
  arn           String?   // Acknowledgment Reference Number
  filingMode    String?   // 'ONLINE' | 'OFFLINE'
  
  // GSTR-1 Data (Outward Supplies)
  b2bInvoices   Json?     // B2B supplies (business to business)
  b2cLargeInvoices Json?  // B2C supplies > 2.5L  
  b2cSmallInvoices Json?  // B2C supplies < 2.5L (state-wise)
  exportInvoices Json?    // Zero-rated supplies under LUT
  creditNotes   Json?     // Credit notes issued
  debitNotes    Json?     // Debit notes issued
  nilRated      Json?     // Nil, exempted, non-GST supplies
  advances      Json?     // Advance receipts
  adjustments   Json?     // Adjustments to advances
  hsnSummary    Json?     // HSN-wise summary (mandatory if turnover > 5cr)
  docSummary    Json?     // Document issued summary
  
  // GSTR-3B Data (Summary Return)
  outwardTaxable   Decimal? // 3.1(a) - Outward taxable supplies
  outwardZeroRated Decimal? // 3.1(b) - Zero rated supplies
  outwardExempted  Decimal? // 3.1(c) - Exempted supplies
  inwardReverseCharge Decimal? // 3.1(d) - Inward supplies liable to reverse charge
  outwardNonGst    Decimal? // 3.1(e) - Non-GST supplies
  
  // ITC Data (Table 4)
  itcImportGoods   Decimal? // 4(A)(1) - Import of goods
  itcImportServices Decimal? // 4(A)(2) - Import of services
  itcInwardSupplies Decimal? // 4(A)(3) - Inward supplies from ISD
  itcInwardISD     Decimal? // 4(A)(4) - Inward supplies from ISD
  itcOther         Decimal? // 4(A)(5) - All other ITC
  itcReversed      Decimal? // 4(B) - ITC reversed
  itcNet           Decimal? // 4(C) - Net ITC available
  itcIneligible    Decimal? // 4(D) - Ineligible ITC
  
  // Tax Liability (Table 6)
  cgstLiability    Decimal? // Central GST
  sgstLiability    Decimal? // State GST
  igstLiability    Decimal? // Integrated GST
  cessLiability    Decimal? // Cess
  totalTaxLiability Decimal? // Total tax liability
  
  // Tax Payment
  cgstPaid         Decimal?
  sgstPaid         Decimal?
  igstPaid         Decimal?
  cessPaid         Decimal?
  totalTaxPaid     Decimal?
  
  // Interest & Late Fee
  interest         Decimal?
  lateFee          Decimal?
  penalty          Decimal?
  
  // JSON Output for GST Portal
  jsonOutput    Json?      // Complete JSON in GST portal format
  validationErrors Json?    // Validation errors if any
  
  // Reconciliation
  matchedInvoices  Int?     // Count of matched invoices with GSTR-2A
  mismatchedInvoices Int?   // Count of mismatched invoices
  pendingInvoices  Int?     // Count of pending invoices
  
  // Audit Trail
  preparedBy       String?
  preparedAt       DateTime?
  reviewedBy       String?
  reviewedAt       DateTime?
  approvedBy       String?
  approvedAt       DateTime?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, returnType, period])
  @@index([userId])
  @@index([returnType])
  @@index([period])
  @@index([filingStatus])
  @@index([financialYear])
}

model Vendor {
  id            String   @id @default(cuid())
  userId        String
  name          String
  gstin         String?  // GSTIN for registered vendors
  pan           String?  // PAN for unregistered vendors
  vendorType    String   @default("COMPANY") // 'INDIVIDUAL' | 'COMPANY' | 'HUF' | 'FIRM' | 'TRUST'
  address       String
  stateCode     String   // State code for place of supply
  email         String?
  phone         String?
  isRegistered  Boolean  @default(true) // GST registered or not
  isActive      Boolean  @default(true)
  
  // TDS Settings
  tdsApplicable Boolean  @default(true) // Whether TDS should be deducted
  lowerTDSRate  Decimal? // Lower TDS rate if certificate provided
  lowerTDSCertificateNo String? // Certificate number for lower TDS
  lowerTDSValidTill DateTime? // Validity of lower TDS certificate
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  purchases PurchaseInvoice[]
  tdsDeductions TDSDeduction[]
  tdsCertificates TDSCertificate[]
  rcmTransactions RCMTransaction[]
  
  @@index([userId])
  @@index([gstin])
  @@index([pan])
}

model PurchaseInvoice {
  id              String   @id @default(cuid())
  userId          String
  vendorId        String
  invoiceNumber   String
  invoiceDate     DateTime
  placeOfSupply   String   // State code
  
  // Tax details
  taxableAmount   Decimal
  cgstRate        Decimal  @default(0)
  sgstRate        Decimal  @default(0)
  igstRate        Decimal  @default(0)
  cgstAmount      Decimal  @default(0)
  sgstAmount      Decimal  @default(0)
  igstAmount      Decimal  @default(0)
  cessAmount      Decimal  @default(0)
  totalGSTAmount  Decimal  @default(0)
  totalAmount     Decimal
  
  // TDS Details
  tdsApplicable   Boolean  @default(false)
  tdsSection      String?  // TDS section code (e.g., '194C', '194J')
  tdsRate         Decimal  @default(0)
  tdsAmount       Decimal  @default(0)
  netPayableAmount Decimal? // Total amount - TDS amount
  
  // ITC Details
  itcEligible     Boolean  @default(true)
  itcCategory     String   @default("INPUTS") // 'INPUTS' | 'CAPITAL_GOODS' | 'INPUT_SERVICES' | 'BLOCKED'
  itcClaimed      Decimal  @default(0)
  itcReversed     Decimal  @default(0)
  reversalReason  String?
  
  // Reconciliation
  gstr2aMatched   Boolean  @default(false)
  matchStatus     String   @default("NOT_AVAILABLE") // 'MATCHED' | 'MISMATCHED' | 'NOT_AVAILABLE'
  gstr2bReference String?  // Reference from GSTR-2B if matched
  
  // RCM Details
  rcmApplicable   Boolean  @default(false)
  
  // Additional Info
  description     String?
  notes           String?
  documentUrl     String?  // Upload purchase invoice PDF
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  vendor Vendor @relation(fields: [vendorId], references: [id])
  lineItems PurchaseLineItem[]
  tdsDeductions TDSDeduction[]
  rcmTransactions RCMTransaction[]
  
  @@unique([userId, vendorId, invoiceNumber])
  @@index([userId])
  @@index([vendorId])
  @@index([invoiceDate])
  @@index([matchStatus])
}

model PurchaseLineItem {
  id                String  @id @default(cuid())
  purchaseInvoiceId String
  description       String
  hsnSacCode        String  // HSN/SAC code
  quantity          Decimal
  rate              Decimal
  amount            Decimal
  gstRate           Decimal @default(0)
  cgstAmount        Decimal @default(0)
  sgstAmount        Decimal @default(0)
  igstAmount        Decimal @default(0)
  
  purchaseInvoice PurchaseInvoice @relation(fields: [purchaseInvoiceId], references: [id], onDelete: Cascade)
  
  @@index([purchaseInvoiceId])
}

// Credit and Debit Notes Models

model CreditNote {
  id                String   @id @default(cuid())
  userId            String
  noteNumber        String   @unique // Format: CN-FY24-25/001
  noteDate          DateTime
  originalInvoiceId String
  reason            String   // 'RATE_CHANGE' | 'QUANTITY_CHANGE' | 'DISCOUNT' | 'RETURN' | 'OTHER'
  reasonDescription String?
  
  // Financial Details
  currency          String   @default("INR")
  
  // GST Adjustments (amount being credited back)
  taxableAmountDiff Decimal  // Positive value for reduction
  cgstDiff          Decimal  @default(0)
  sgstDiff          Decimal  @default(0)
  igstDiff          Decimal  @default(0)
  totalGSTDiff      Decimal  @default(0)
  totalDiff         Decimal  // Total amount being credited
  
  // Status
  status            String   @default("DRAFT") // 'DRAFT' | 'ISSUED' | 'CANCELLED'
  
  // PDF Storage
  pdfUrl            String?
  pdfGeneratedAt    DateTime?
  
  // Additional Info
  notes             String?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  originalInvoice   Invoice  @relation(fields: [originalInvoiceId], references: [id])
  lineItems         CreditNoteLineItem[]
  
  @@index([userId])
  @@index([originalInvoiceId])
  @@index([status])
  @@index([noteDate])
}

model CreditNoteLineItem {
  id              String  @id @default(cuid())
  creditNoteId    String
  description     String
  serviceCode     String  // HSN/SAC code
  quantity        Decimal
  rate            Decimal
  amount          Decimal // Amount being credited (positive)
  gstRate         Decimal @default(0)
  cgstAmount      Decimal @default(0)
  sgstAmount      Decimal @default(0)
  igstAmount      Decimal @default(0)
  
  creditNote      CreditNote @relation(fields: [creditNoteId], references: [id], onDelete: Cascade)
  
  @@index([creditNoteId])
}

model DebitNote {
  id                String   @id @default(cuid())
  userId            String
  noteNumber        String   @unique // Format: DN-FY24-25/001
  noteDate          DateTime
  originalInvoiceId String
  reason            String   // 'RATE_INCREASE' | 'QUANTITY_INCREASE' | 'ADDITIONAL_CHARGE' | 'PENALTY' | 'OTHER'
  reasonDescription String?
  
  // Financial Details
  currency          String   @default("INR")
  
  // GST Adjustments (additional amount being charged)
  taxableAmountDiff Decimal  // Positive value for addition
  cgstDiff          Decimal  @default(0)
  sgstDiff          Decimal  @default(0)
  igstDiff          Decimal  @default(0)
  totalGSTDiff      Decimal  @default(0)
  totalDiff         Decimal  // Total additional amount being charged
  
  // Status
  status            String   @default("DRAFT") // 'DRAFT' | 'ISSUED' | 'CANCELLED'
  
  // PDF Storage
  pdfUrl            String?
  pdfGeneratedAt    DateTime?
  
  // Additional Info
  notes             String?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  originalInvoice   Invoice  @relation(fields: [originalInvoiceId], references: [id])
  lineItems         DebitNoteLineItem[]
  
  @@index([userId])
  @@index([originalInvoiceId])
  @@index([status])
  @@index([noteDate])
}

model DebitNoteLineItem {
  id              String  @id @default(cuid())
  debitNoteId     String
  description     String
  serviceCode     String  // HSN/SAC code
  quantity        Decimal
  rate            Decimal
  amount          Decimal // Additional amount being charged (positive)
  gstRate         Decimal @default(0)
  cgstAmount      Decimal @default(0)
  sgstAmount      Decimal @default(0)
  igstAmount      Decimal @default(0)
  
  debitNote       DebitNote @relation(fields: [debitNoteId], references: [id], onDelete: Cascade)
  
  @@index([debitNoteId])
}

// ITC Management Models

model ITCRegister {
  id              String   @id @default(cuid())
  userId          String
  period          String   // Format: MM-YYYY
  financialYear   String   // Format: FY24-25
  
  // ITC Balances
  openingBalance  Decimal  @default(0)
  eligibleITC     Decimal  @default(0)
  claimedITC      Decimal  @default(0)
  reversedITC     Decimal  @default(0)
  blockedITC      Decimal  @default(0)
  closingBalance  Decimal  @default(0)
  
  // Breakup by category
  inputsITC       Decimal  @default(0)
  capitalGoodsITC Decimal  @default(0)
  inputServicesITC Decimal @default(0)
  
  // Reconciliation Status
  isReconciled    Boolean  @default(false)
  reconciledAt    DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, period])
  @@index([userId])
  @@index([period])
  @@index([financialYear])
}

// Recurring Invoice & Subscription Models

model RecurringInvoice {
  id              String   @id @default(cuid())
  userId          String
  templateName    String
  clientId        String
  
  // Schedule Configuration
  frequency       String    // 'DAILY' | 'WEEKLY' | 'MONTHLY' | 'QUARTERLY' | 'YEARLY'
  interval        Int       // Every N periods
  dayOfWeek       Int?      // For weekly (0-6)
  dayOfMonth      Int?      // For monthly (1-31)
  monthOfYear     Int?      // For yearly (1-12)
  
  // Period
  startDate       DateTime
  endDate         DateTime?
  nextRunDate     DateTime
  occurrences     Int?      // Total number of invoices to generate
  generatedCount  Int       @default(0)
  
  // Invoice Template
  invoiceType     String    // 'EXPORT' | 'DOMESTIC_B2B' | 'DOMESTIC_B2C'
  currency        String
  paymentTerms    Int       // Days
  serviceCode     String    // Default HSN/SAC code
  placeOfSupply   String    @default("Outside India (Section 2-6)")
  lutId           String?   // Reference to LUT (for exports)
  
  // Template Management
  customFields    Json?     // Project metadata and custom properties
  currentVersionId String?  // Current version ID for the template
  
  // Advanced Scheduling
  skipWeekends    Boolean   @default(false) // Skip weekends for invoice generation
  skipHolidays    Boolean   @default(false) // Skip holidays for invoice generation
  holidayCalendar Json?     // Array of holiday dates
  timezone        String    @default("Asia/Kolkata") // Timezone for scheduling
  scheduleTime    String?   // Time in HH:mm format for invoice generation
  
  // Status
  status          String    @default("ACTIVE") // 'ACTIVE' | 'PAUSED' | 'COMPLETED' | 'CANCELLED'
  pausedAt        DateTime?
  
  // Notifications
  sendAutomatically Boolean @default(false)
  ccEmails        String[]
  emailTemplate   String?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  client          Client    @relation(fields: [clientId], references: [id])
  lut             LUT?      @relation(fields: [lutId], references: [id])
  lineItems       RecurringLineItem[]
  generatedInvoices Invoice[]
  subscriptions   Subscription[]
  analytics       TemplateAnalytics[]
  versions        TemplateVersion[]
  currentVersion  TemplateVersion? @relation("CurrentVersion", fields: [currentVersionId], references: [id])
  
  @@index([userId])
  @@index([clientId])
  @@index([status])
  @@index([nextRunDate])
}

model RecurringLineItem {
  id                String   @id @default(cuid())
  recurringInvoiceId String
  description       String
  hsnCode           String
  quantity          Decimal
  rate              Decimal
  
  // For usage-based billing
  isVariable        Boolean  @default(false)
  minimumQuantity   Decimal?
  maximumQuantity   Decimal?
  
  recurringInvoice  RecurringInvoice @relation(fields: [recurringInvoiceId], references: [id], onDelete: Cascade)
  usageTracking     UsageTracking[]
  
  @@index([recurringInvoiceId])
}

model UsageTracking {
  id          String   @id @default(cuid())
  lineItemId  String
  period      DateTime
  quantity    Decimal
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  lineItem    RecurringLineItem @relation(fields: [lineItemId], references: [id], onDelete: Cascade)
  
  @@index([lineItemId])
  @@index([period])
}

model Subscription {
  id                 String   @id @default(cuid())
  userId             String
  clientId           String
  planName           String
  
  // Billing
  billingCycle       String    // 'MONTHLY' | 'QUARTERLY' | 'YEARLY'
  amount             Decimal
  currency           String
  
  // Period
  startDate          DateTime
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelledAt        DateTime?
  
  // Trial
  trialStart         DateTime?
  trialEnd           DateTime?
  
  // Status
  status             String    @default("ACTIVE") // 'TRIALING' | 'ACTIVE' | 'CANCELLED' | 'PAST_DUE'
  
  // Prorated billing
  prorateChanges     Boolean   @default(true)
  
  // Associated recurring invoice
  recurringInvoiceId String?
  
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  
  user               User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  client             Client    @relation(fields: [clientId], references: [id])
  recurringInvoice   RecurringInvoice? @relation(fields: [recurringInvoiceId], references: [id])
  
  @@index([userId])
  @@index([clientId])
  @@index([status])
  @@index([currentPeriodEnd])
}

// Advance Payments & Receipts Management
model AdvanceReceipt {
  id                String    @id @default(cuid())
  userId            String
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  receiptNumber     String    // Format: ADV-FY24-25/001
  receiptDate       DateTime
  clientId          String
  client            Client    @relation(fields: [clientId], references: [id])
  
  // Amount Details
  currency          String
  amount            Decimal
  exchangeRate      Decimal
  amountINR         Decimal
  
  // Payment Details
  paymentMode       String    // 'WIRE' | 'CHEQUE' | 'UPI' | 'CASH'
  bankReference     String?
  bankName          String?
  chequeNumber      String?
  chequeDate        DateTime?
  
  // GST on Advance (rarely applicable for exports)
  isGSTApplicable   Boolean   @default(false)
  gstRate           Decimal?
  cgstAmount        Decimal?
  sgstAmount        Decimal?
  igstAmount        Decimal?
  
  // Adjustment Details
  adjustedAmount    Decimal   @default(0)
  unadjustedAmount  Decimal
  status            String    // 'RECEIVED' | 'PARTIALLY_ADJUSTED' | 'FULLY_ADJUSTED' | 'REFUNDED'
  
  // Links
  adjustments       AdvanceAdjustment[]
  refunds           AdvanceRefund[]
  
  // Documents
  receiptPDF        String?
  acknowledgment    String?
  
  // Metadata
  notes             String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@unique([userId, receiptNumber])
  @@index([clientId])
  @@index([status])
}

model AdvanceAdjustment {
  id                String    @id @default(cuid())
  advanceReceiptId  String
  advanceReceipt    AdvanceReceipt @relation(fields: [advanceReceiptId], references: [id], onDelete: Cascade)
  invoiceId         String
  invoice           Invoice   @relation(fields: [invoiceId], references: [id])
  
  adjustmentDate    DateTime
  adjustedAmount    Decimal
  
  // GST Adjustment (if advance had GST)
  gstAdjusted       Decimal?
  
  remarks           String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([advanceReceiptId])
  @@index([invoiceId])
}

model AdvanceRefund {
  id                String    @id @default(cuid())
  advanceReceiptId  String
  advanceReceipt    AdvanceReceipt @relation(fields: [advanceReceiptId], references: [id], onDelete: Cascade)
  refundNumber      String
  refundDate        DateTime
  refundAmount      Decimal
  
  // Refund Details
  refundMode        String
  bankReference     String?
  
  // GST on Refund
  gstRefunded       Decimal?
  
  reason            String
  approvedBy        String?
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@unique([refundNumber])
  @@index([advanceReceiptId])
}

// GST Return Management Models

model GSTReconciliation {
  id               String    @id @default(cuid())
  userId           String
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Period
  period           String    // 'MM-YYYY'
  reconciliationType String  // 'GSTR1_GSTR3B' | 'GSTR2A_PURCHASES' | 'GSTR2B_ITC'
  
  // Status
  status           String    @default("PENDING") // 'PENDING' | 'IN_PROGRESS' | 'COMPLETED' | 'FAILED'
  startedAt        DateTime?
  completedAt      DateTime?
  
  // Summary
  totalRecords     Int       @default(0)
  matchedRecords   Int       @default(0)
  mismatchedRecords Int      @default(0)
  missingInPortal  Int       @default(0)
  missingInSystem  Int       @default(0)
  
  // Mismatch Details
  mismatchDetails  Json?     // Detailed mismatch information
  
  // Actions Taken
  actionsRequired  Json?     // List of required actions
  actionsTaken     Json?     // List of completed actions
  
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  
  @@unique([userId, period, reconciliationType])
  @@index([userId])
  @@index([period])
  @@index([status])
}

// TDS/TCS Management Models

model TDSConfiguration {
  id                String    @id @default(cuid())
  userId            String    @unique
  tanNumber         String    // 10-character TAN (Tax Deduction Account Number)
  deductorName      String    // Name of the deductor (business name)
  deductorPAN       String    // PAN of the deductor
  deductorType      String    // 'COMPANY' | 'INDIVIDUAL' | 'HUF' | 'FIRM' | 'TRUST'
  responsiblePerson String    // Person responsible for TDS
  designation       String    // Designation of responsible person
  address           String    // Deductor address
  city              String
  stateCode         String
  pincode           String
  email             String
  phone             String
  
  // Settings
  isActive          Boolean   @default(true)
  autoDeduct        Boolean   @default(true) // Automatically calculate TDS
  emailCertificates Boolean   @default(true) // Email Form 16A to vendors
  
  // Audit Trail
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([tanNumber])
}

model TDSSection {
  id                String    @id @default(cuid())
  sectionCode       String    @unique // '194C', '194J', '194H', etc.
  description       String    // 'Contracts', 'Professional Services', etc.
  
  // Rates (in percentage)
  individualRate    Decimal   // Rate for individuals
  companyRate       Decimal   // Rate for companies
  hufRate           Decimal?  // Rate for HUF (if different)
  
  // Threshold
  thresholdLimit    Decimal   // Annual threshold amount
  singleLimit       Decimal?  // Single transaction limit (if applicable)
  
  // Applicability
  applicableFor     String[]  // ['GOODS', 'SERVICES', 'BOTH']
  natureOfPayment   String[]  // Types of payments covered
  
  // Additional Info
  surchargeRate     Decimal   @default(0) // Surcharge rate if applicable
  eduCessRate       Decimal   @default(4) // Education cess (usually 4%)
  
  isActive          Boolean   @default(true)
  effectiveFrom     DateTime
  effectiveTo       DateTime?
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  deductions        TDSDeduction[]
  
  @@index([sectionCode])
  @@index([isActive])
}

model TDSDeduction {
  id                String    @id @default(cuid())
  userId            String
  
  // Link to Purchase Invoice or Payment
  purchaseInvoiceId String?
  paymentId         String?
  vendorId          String
  
  // TDS Details
  sectionId         String    // Reference to TDSSection
  section           TDSSection @relation(fields: [sectionId], references: [id])
  
  // Financial Details
  taxableAmount     Decimal   // Amount on which TDS is calculated
  tdsRate           Decimal   // Actual rate applied (considering vendor type)
  tdsAmount         Decimal   // TDS amount
  surcharge         Decimal   @default(0)
  eduCess           Decimal   @default(0)
  totalTDS          Decimal   // Total TDS including surcharge and cess
  
  // Vendor Details (captured at time of deduction)
  vendorName        String
  vendorPAN         String
  vendorType        String    // 'INDIVIDUAL' | 'COMPANY' | 'HUF' | 'FIRM' | 'TRUST'
  
  // Deduction Date
  deductionDate     DateTime
  financialYear     String    // 'FY24-25'
  quarter           String    // 'Q1', 'Q2', 'Q3', 'Q4'
  
  // Payment Status
  depositStatus     String    @default("PENDING") // 'PENDING' | 'DEPOSITED' | 'LATE'
  depositDueDate    DateTime  // Due date for deposit (7th of next month typically)
  
  // Certificate Details
  certificateId     String?
  certificateIssued Boolean   @default(false)
  
  // Payment Details
  tdsPaymentId      String?   // Link to TDS payment
  
  // Notes
  notes             String?
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  vendor            Vendor    @relation(fields: [vendorId], references: [id])
  purchaseInvoice   PurchaseInvoice? @relation(fields: [purchaseInvoiceId], references: [id])
  certificate       TDSCertificate? @relation(fields: [certificateId], references: [id])
  tdsPayment        TDSPayment? @relation(fields: [tdsPaymentId], references: [id])
  
  @@index([userId])
  @@index([vendorId])
  @@index([purchaseInvoiceId])
  @@index([financialYear, quarter])
  @@index([depositStatus])
  @@index([deductionDate])
}

model TDSPayment {
  id                String    @id @default(cuid())
  userId            String
  
  // Challan Details
  challanNumber     String    @unique // BSR Code + Date + Serial
  challanDate       DateTime
  bsrCode           String    // Bank BSR code (7 digits)
  bankName          String
  
  // Period
  financialYear     String    // 'FY24-25'
  quarter           String    // 'Q1', 'Q2', 'Q3', 'Q4'
  assessmentYear    String    // 'AY25-26'
  
  // Tax Types
  section           String    // TDS section or 'MULTIPLE' for combined payment
  
  // Amounts
  tdsAmount         Decimal   // Basic TDS
  surcharge         Decimal   @default(0)
  eduCess           Decimal   @default(0)
  interest          Decimal   @default(0) // Interest for late payment
  penalty           Decimal   @default(0) // Penalty if any
  totalAmount       Decimal   // Total amount paid
  
  // Deductions Covered
  deductionIds      String[]  // IDs of TDSDeduction records covered
  deductionCount    Int       // Number of deductions covered
  
  // Payment Mode
  paymentMode       String    // 'ONLINE' | 'OFFLINE' | 'NEFT' | 'RTGS'
  paymentReference  String?
  
  // Status
  status            String    @default("PAID") // 'PAID' | 'REVERSED' | 'CANCELLED'
  acknowledgmentNo  String?   // CIN number from bank
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  deductions        TDSDeduction[]
  
  @@index([userId])
  @@index([financialYear, quarter])
  @@index([challanNumber])
  @@index([challanDate])
}

model TDSCertificate {
  id                String    @id @default(cuid())
  userId            String
  
  // Certificate Details
  certificateNumber String    @unique // Unique certificate number
  form              String    // '16A' for non-salary TDS
  
  // Period
  financialYear     String    // 'FY24-25'
  quarter           String    // 'Q1', 'Q2', 'Q3', 'Q4'
  
  // Vendor Details
  vendorId          String
  vendorName        String
  vendorPAN         String
  vendorAddress     String
  
  // Summary
  totalTDS          Decimal   // Total TDS for the period
  totalPaid         Decimal   // Total amount paid to vendor
  
  // Deductions
  deductions        TDSDeduction[]
  deductionDetails  Json      // Detailed breakdown of deductions
  
  // Generation
  generatedDate     DateTime
  issuedDate        DateTime?
  
  // Documents
  pdfUrl            String?
  pdfGeneratedAt    DateTime?
  
  // Email Status
  emailSent         Boolean   @default(false)
  emailSentAt       DateTime?
  emailTo           String?
  
  // Status
  status            String    @default("DRAFT") // 'DRAFT' | 'ISSUED' | 'CANCELLED' | 'REVISED'
  revisedFrom       String?   // Previous certificate number if revised
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  vendor            Vendor    @relation(fields: [vendorId], references: [id])
  
  @@index([userId])
  @@index([vendorId])
  @@index([financialYear, quarter])
  @@index([certificateNumber])
}

model TDSReturn {
  id                String    @id @default(cuid())
  userId            String
  
  // Return Details
  returnType        String    // '24Q' (non-salary), '26Q' (other than salary), '27Q' (non-resident)
  financialYear     String    // 'FY24-25'
  quarter           String    // 'Q1', 'Q2', 'Q3', 'Q4'
  formType          String    // 'ORIGINAL' | 'REVISED'
  
  // TAN Details
  tanNumber         String
  assessmentYear    String    // 'AY25-26'
  
  // Summary
  totalDeductions   Int       // Number of deduction records
  totalTDS          Decimal   // Total TDS amount
  totalDeposited    Decimal   // Total amount deposited
  totalCertificates Int       // Number of certificates issued
  
  // Deduction Details by Section
  sectionWiseSummary Json     // Summary by TDS section
  
  // Challan Details
  challanCount      Int       // Number of challans
  challanDetails    Json      // Challan information
  
  // Filing Details
  filingStatus      String    @default("DRAFT") // 'DRAFT' | 'READY' | 'FILED' | 'ACCEPTED' | 'REJECTED'
  filingDate        DateTime?
  acknowledgmentNo  String?   // Receipt number from TRACES
  tokenNumber       String?   // Token number for filing
  
  // Validation
  validationErrors  Json?     // List of validation errors
  validationStatus  String?   // 'PASSED' | 'FAILED' | 'WARNINGS'
  
  // Documents
  returnFileUrl     String?   // FVU file or return file
  formFileUrl       String?   // Form 27A (summary)
  
  // Audit Trail
  preparedBy        String?
  preparedAt        DateTime?
  reviewedBy        String?
  reviewedAt        DateTime?
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, returnType, financialYear, quarter])
  @@index([userId])
  @@index([returnType])
  @@index([financialYear, quarter])
  @@index([filingStatus])
}

// E-Invoice Models

model EInvoiceConfig {
  id                String   @id @default(cuid())
  userId            String   @unique
  
  // GSP Configuration
  gspProvider       String   // 'CLEARTAX' | 'VAYANA' | 'CYGNET' | 'CUSTOM'
  gspUrl            String?  // Custom GSP API URL
  environment       String   @default("SANDBOX") // 'SANDBOX' | 'PRODUCTION'
  
  // Credentials
  clientId          String?
  clientSecret      String?  // Encrypted
  username          String
  password          String   // Encrypted
  gstin             String   // GSTIN for e-invoicing
  
  // Settings
  autoGenerate      Boolean  @default(false)
  autoCancel        Boolean  @default(false)
  cancelWithin      Int      @default(24) // Hours
  includeQRCode     Boolean  @default(true)
  bulkGeneration    Boolean  @default(false)
  
  // E-Way Bill Integration
  ewayBillEnabled   Boolean  @default(false)
  ewayBillThreshold Decimal  @default(50000) // Amount threshold
  transportMode     String?  // Default transport mode
  transporterId     String?  // Default transporter ID
  
  isActive          Boolean  @default(true)
  lastSyncAt        DateTime?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  authTokens        EInvoiceAuthToken[]
  
  @@index([userId])
  @@index([gstin])
}

model EInvoiceAuthToken {
  id                String   @id @default(cuid())
  configId          String
  
  // Token Details
  authToken         String   @db.Text // JWT token
  sessionKey        String?  // SEK for encryption
  tokenExpiry       DateTime // Token expiry time (6 hours)
  
  // Token Type
  tokenType         String   @default("IRP") // 'IRP' | 'EWAY'
  
  // Status
  isActive          Boolean  @default(true)
  revokedAt         DateTime?
  
  createdAt         DateTime @default(now())
  
  config            EInvoiceConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  
  @@index([configId])
  @@index([tokenExpiry])
  @@index([isActive])
}

model EInvoice {
  id                String   @id @default(cuid())
  userId            String
  invoiceId         String   @unique
  
  // IRN Details
  irn               String?  @unique // 64-character Invoice Reference Number
  ackNo             String?  // Acknowledgment number (15 digits)
  ackDate           DateTime? // Acknowledgment date from IRP
  
  // QR Code
  signedQRCode      String?  @db.Text // Signed QR code data
  qrCodeUrl         String?  // URL to QR code image
  
  // Document Details
  docType           String   // 'INV' | 'CRN' | 'DBN'
  docNo             String   // Invoice/Credit/Debit Note number
  docDate           DateTime
  
  // Supply Type
  supplyType        String   // 'B2B' | 'SEZWP' | 'SEZWOP' | 'EXPWP' | 'EXPWOP' | 'DEXP'
  
  // Seller Details (cached)
  sellerGstin       String
  sellerName        String
  sellerAddress     String
  
  // Buyer Details (cached)
  buyerGstin        String?
  buyerName         String
  buyerAddress      String
  buyerStateCode    String
  
  // Values
  totalValue        Decimal
  totalGstValue     Decimal
  totalInvoiceValue Decimal
  
  // JSON Payload
  requestPayload    Json     // Complete JSON sent to IRP
  responsePayload   Json?    // Complete response from IRP
  
  // Status
  status            String   @default("PENDING") // 'PENDING' | 'GENERATED' | 'CANCELLED' | 'FAILED'
  errorMessage      String?
  errorCode         String?
  
  // Cancellation
  cancelledAt       DateTime?
  cancelReason      String?
  cancelRemarks     String?
  cancelIRN         String?  // Cancellation IRN
  
  // E-Way Bill
  ewayBillNo        String?
  ewayBillDate      DateTime?
  ewayBillValidTill DateTime?
  
  // Retry Management
  retryCount        Int      @default(0)
  lastRetryAt       DateTime?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  invoice           Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([invoiceId])
  @@index([irn])
  @@index([status])
  @@index([docDate])
  @@index([ackDate])
}

model EWayBill {
  id                String   @id @default(cuid())
  userId            String
  eInvoiceId        String?  // Optional link to e-invoice
  
  // E-Way Bill Details
  ewayBillNo        String   @unique
  ewayBillDate      DateTime
  validFrom         DateTime
  validUntil        DateTime
  
  // Document Reference
  docType           String   // 'INV' | 'CRN' | 'DBN' | 'CHL'
  docNo             String
  docDate           DateTime
  
  // Supply Details
  supplyType        String   // 'I' (Inward) | 'O' (Outward)
  subSupplyType     String   // Supply sub-type code
  transactionType   String   // 'Regular' | 'Bill To Ship To' | 'Bill From Dispatch From' | 'Combination'
  
  // Transport Details
  transportMode     String   // 'Road' | 'Rail' | 'Air' | 'Ship'
  transporterId     String?
  transporterName   String?
  transportDocNo    String?  // LR/RR/Airway Bill No
  transportDocDate  DateTime?
  vehicleNo         String?
  vehicleType       String?  // 'Regular' | 'ODC'
  
  // From/To Details
  fromGstin         String?
  fromTradeName     String
  fromAddress       String
  fromPlace         String
  fromPincode       String
  fromStateCode     String
  
  toGstin           String?
  toTradeName       String
  toAddress         String
  toPlace           String
  toPincode         String
  toStateCode       String
  
  // Distance & Values
  distance          Int      // in KM
  totalValue        Decimal
  totalGstValue     Decimal
  cessValue         Decimal?
  cessNonAdvolValue Decimal?
  otherValue        Decimal?
  totalInvoiceValue Decimal
  
  // Items (simplified)
  mainHsnCode       String   // Main HSN code
  itemList          Json     // List of items
  
  // Status
  status            String   @default("ACTIVE") // 'ACTIVE' | 'CANCELLED' | 'EXPIRED'
  cancelledAt       DateTime?
  cancelReason      String?
  cancelRemarks     String?
  
  // Part B Updates (for multi-vehicle transport)
  partBUpdates      Json?    // Array of vehicle updates
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([ewayBillNo])
  @@index([status])
  @@index([validUntil])
  @@index([docNo])
}

// Template Analytics Models

model TemplateAnalytics {
  id          String   @id @default(cuid())
  templateId  String   // Reference to RecurringInvoice
  metric      String   // e.g., 'revenue', 'conversion_rate', 'churn_rate'
  value       Decimal
  period      String   // e.g., 'daily', 'weekly', 'monthly'
  timestamp   DateTime
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  template    RecurringInvoice @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@index([metric])
  @@index([period])
  @@index([timestamp])
}

// Template Version Management Models

model TemplateVersion {
  id                String   @id @default(cuid())
  templateId        String   // Reference to RecurringInvoice
  version           String   // Version number (e.g., '1.0.0', '1.1.0')
  changes           Json     // What changed in this version
  effectiveDate     DateTime // When this version becomes effective
  createdBy         String   // User who created this version
  previousVersionId String?  // Link to previous version for history chain
  
  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  template          RecurringInvoice @relation(fields: [templateId], references: [id], onDelete: Cascade)
  previousVersion   TemplateVersion? @relation("VersionHistory", fields: [previousVersionId], references: [id])
  nextVersions      TemplateVersion[] @relation("VersionHistory")
  currentVersionOf  RecurringInvoice[] @relation("CurrentVersion")
  
  @@index([templateId])
  @@index([version])
  @@index([effectiveDate])
  @@index([createdBy])
  @@index([previousVersionId])
}

// Client Portal Models

model ClientPortalAccess {
  id              String    @id @default(cuid())
  clientId        String    @unique
  userId          String    // Business owner who granted access
  
  // Magic Link Authentication
  isEnabled       Boolean   @default(false)
  email           String    // Client's email for portal access
  
  // Access Permissions
  canViewInvoices Boolean   @default(true)
  canRecordPayments Boolean @default(true)
  canDownloadDocuments Boolean @default(true)
  canViewPaymentHistory Boolean @default(true)
  
  // Security Settings
  sessionTimeout  Int       @default(30) // minutes
  requireMFA      Boolean   @default(false)
  allowedIPs      String[]  // IP whitelist (optional)
  
  // Usage Tracking
  lastLoginAt     DateTime?
  loginCount      Int       @default(0)
  isActive        Boolean   @default(true)
  
  // Audit Trail
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  client          Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessions        ClientPortalSession[]
  loginTokens     ClientPortalLoginToken[]
  activityLogs    ClientPortalActivity[]
  
  @@index([clientId])
  @@index([userId])
  @@index([email])
  @@index([isActive])
}

model ClientPortalSession {
  id              String    @id @default(cuid())
  portalAccessId  String
  sessionToken    String    @unique
  
  // Session Details
  ipAddress       String?
  userAgent       String?
  location        String?   // Derived from IP
  
  // Session Lifecycle
  expiresAt       DateTime
  lastActivity    DateTime  @default(now())
  isActive        Boolean   @default(true)
  
  // Security
  csrfToken       String?
  fingerprintHash String?   // Browser fingerprint
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  portalAccess    ClientPortalAccess @relation(fields: [portalAccessId], references: [id], onDelete: Cascade)
  
  @@index([portalAccessId])
  @@index([sessionToken])
  @@index([expiresAt])
  @@index([isActive])
}

model ClientPortalLoginToken {
  id              String    @id @default(cuid())
  portalAccessId  String
  token           String    @unique
  
  // Magic Link Details
  email           String
  purpose         String    @default("LOGIN") // 'LOGIN' | 'PASSWORD_RESET'
  
  // Token Lifecycle
  expiresAt       DateTime  // Typically 15 minutes
  usedAt          DateTime?
  isUsed          Boolean   @default(false)
  
  // Security
  ipAddress       String?
  userAgent       String?
  attempts        Int       @default(0)
  maxAttempts     Int       @default(3)
  
  createdAt       DateTime  @default(now())
  
  portalAccess    ClientPortalAccess @relation(fields: [portalAccessId], references: [id], onDelete: Cascade)
  
  @@index([portalAccessId])
  @@index([token])
  @@index([email])
  @@index([expiresAt])
  @@index([isUsed])
}

model ClientPortalActivity {
  id              String    @id @default(cuid())
  portalAccessId  String
  
  // Activity Details
  action          String    // 'LOGIN', 'LOGOUT', 'VIEW_INVOICE', 'DOWNLOAD_PDF', 'RECORD_PAYMENT'
  entityType      String?   // 'INVOICE', 'PAYMENT', 'DOCUMENT'
  entityId        String?   // ID of the entity accessed
  
  // Request Details
  ipAddress       String?
  userAgent       String?
  requestPath     String?
  httpMethod      String?
  
  // Response Details
  statusCode      Int?
  errorMessage    String?
  
  // Metadata
  metadata        Json?     // Additional context data
  duration        Int?      // Request duration in ms
  
  timestamp       DateTime  @default(now())
  
  portalAccess    ClientPortalAccess @relation(fields: [portalAccessId], references: [id], onDelete: Cascade)
  
  @@index([portalAccessId])
  @@index([action])
  @@index([entityType])
  @@index([timestamp])
  @@index([ipAddress])
}

model ClientPaymentSubmission {
  id              String    @id @default(cuid())
  clientId        String
  invoiceId       String
  
  // Payment Details
  amount          Decimal   // Amount client claims to have paid
  currency        String
  paymentDate     DateTime
  paymentMethod   String    // 'WIRE', 'ACH', 'SWIFT', 'CARD', 'OTHER'
  
  // Reference Information
  transactionRef  String?   // Bank transaction reference
  bankName        String?
  accountLastFour String?   // Last 4 digits of account used
  
  // Attachments
  receiptUrls     String[]  // URLs to uploaded payment receipts
  notes           String?   // Client notes about the payment
  
  // Verification Status
  status          String    @default("SUBMITTED") // 'SUBMITTED', 'VERIFIED', 'REJECTED', 'PROCESSING'
  verifiedAt      DateTime?
  verifiedBy      String?   // User ID who verified
  verifierNotes   String?   // Admin notes about verification
  
  // Auto-matching
  autoMatched     Boolean   @default(false)
  matchConfidence Decimal?  // 0.0 to 1.0 confidence score
  
  // Integration with existing Payment model
  linkedPaymentId String?   // ID of created Payment record if verified
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  client          Client    @relation(fields: [clientId], references: [id])
  invoice         Invoice   @relation(fields: [invoiceId], references: [id])
  linkedPayment   Payment?  @relation(fields: [linkedPaymentId], references: [id])
  
  @@index([clientId])
  @@index([invoiceId])
  @@index([status])
  @@index([paymentDate])
  @@index([linkedPaymentId])
}

model ClientPortalNotification {
  id              String    @id @default(cuid())
  clientId        String
  
  // Notification Details
  type            String    // 'INVOICE_SENT', 'PAYMENT_RECEIVED', 'INVOICE_OVERDUE', 'PORTAL_ACCESS_GRANTED'
  title           String
  message         String
  
  // Targeting
  invoiceId       String?   // Related invoice if applicable
  
  // Delivery
  channels        String[]  // ['EMAIL', 'IN_APP', 'SMS']
  emailSent       Boolean   @default(false)
  emailSentAt     DateTime?
  
  // Status
  isRead          Boolean   @default(false)
  readAt          DateTime?
  priority        String    @default("NORMAL") // 'LOW', 'NORMAL', 'HIGH', 'URGENT'
  
  // Lifecycle
  expiresAt       DateTime? // For temporary notifications
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  client          Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  invoice         Invoice?  @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  
  @@index([clientId])
  @@index([type])
  @@index([isRead])
  @@index([priority])
  @@index([createdAt])
}

// ============================================================================
// APPROVAL WORKFLOW MODELS
// ============================================================================

model ApprovalRole {
  id              String   @id @default(cuid())
  userId          String
  name            String   // 'MANAGER' | 'FINANCE_HEAD' | 'DIRECTOR' | 'CEO'
  level           Int      // Approval hierarchy level (1 = lowest)
  isActive        Boolean  @default(true)
  
  // Permissions
  canApprove      Boolean  @default(true)
  canReject       Boolean  @default(true)
  canDelegate     Boolean  @default(true)
  canModify       Boolean  @default(false)
  
  // Limits
  maxApprovalAmount Decimal? // Maximum amount they can approve
  currency        String   @default("INR")
  
  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  workflows       ApprovalWorkflow[]
  delegations     ApprovalDelegation[] @relation("FromRole")
  actions         ApprovalAction[]
  
  @@unique([userId, name])
  @@index([userId])
  @@index([level])
  @@index([isActive])
}

model ApprovalRule {
  id              String   @id @default(cuid())
  userId          String
  name            String
  description     String?
  
  // Conditions
  minAmount       Decimal?
  maxAmount       Decimal?
  currency        String   @default("INR")
  invoiceType     String?  // 'EXPORT' | 'DOMESTIC_B2B' | 'DOMESTIC_B2C'
  clientCategory  String?  // Client risk category
  
  // Required Approvals
  requiredApprovals Int    @default(1)
  parallelApproval Boolean @default(false)
  
  // Roles
  approverRoles   String[] // Array of role names
  
  // Settings
  isActive        Boolean  @default(true)
  priority        Int      @default(0) // Higher priority rules checked first
  
  // Timeouts
  approvalTimeout Int?     // Hours before escalation
  escalateToRole  String?  // Role to escalate to
  
  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  workflows       ApprovalWorkflow[]
  
  @@index([userId])
  @@index([priority])
  @@index([isActive])
  @@index([minAmount])
  @@index([maxAmount])
}

model ApprovalWorkflow {
  id              String   @id @default(cuid())
  userId          String
  invoiceId       String   @unique
  ruleId          String
  roleId          String?  // Current approver role
  
  // Workflow Status
  status          String   @default("PENDING") // 'PENDING' | 'APPROVED' | 'REJECTED' | 'EXPIRED' | 'CANCELLED'
  currentLevel    Int      @default(1)
  requiredLevel   Int      // Final level needed for approval
  
  // Metadata
  initiatedBy     String   // User ID who submitted for approval
  initiatedAt     DateTime @default(now())
  completedAt     DateTime?
  
  // Timeouts
  dueDate         DateTime? // When approval is due
  escalatedAt     DateTime?
  escalatedTo     String?   // Role escalated to
  
  // Final Decision
  finalDecision   String?  // 'APPROVED' | 'REJECTED'
  finalDecisionBy String?  // User ID who made final decision
  finalDecisionAt DateTime?
  
  // Bypass
  bypassReason    String?  // Reason for bypass if applicable
  bypassedBy      String?  // User ID who bypassed
  bypassedAt      DateTime?
  
  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  invoice         Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  rule            ApprovalRule @relation(fields: [ruleId], references: [id])
  role            ApprovalRole? @relation(fields: [roleId], references: [id])
  actions         ApprovalAction[]
  notifications   ApprovalNotification[]
  auditLogs       ApprovalAuditLog[]
  
  @@index([userId])
  @@index([invoiceId])
  @@index([status])
  @@index([currentLevel])
  @@index([dueDate])
  @@index([initiatedBy])
  @@index([finalDecision])
  @@index([roleId])
}

model ApprovalAction {
  id              String   @id @default(cuid())
  workflowId      String
  roleId          String
  
  // Action Details
  action          String   // 'APPROVE' | 'REJECT' | 'REQUEST_CHANGES' | 'DELEGATE'
  level           Int      // Approval level at which action was taken
  
  // Decision Details
  decidedBy       String   // User ID who took action
  decidedAt       DateTime @default(now())
  comments        String?
  attachments     String[] // URLs to uploaded documents
  
  // Delegation (if action = 'DELEGATE')
  delegatedTo     String?  // User ID delegated to
  delegatedUntil  DateTime? // Delegation expiry
  delegationReason String?
  
  // Request Changes (if action = 'REQUEST_CHANGES')
  requestedChanges String? // Specific changes requested
  changePriority  String?  // 'LOW' | 'MEDIUM' | 'HIGH' | 'URGENT'
  
  // Metadata
  ipAddress       String?
  userAgent       String?
  
  workflow        ApprovalWorkflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  role            ApprovalRole @relation(fields: [roleId], references: [id])
  
  @@index([workflowId])
  @@index([roleId])
  @@index([decidedBy])
  @@index([decidedAt])
  @@index([action])
  @@index([level])
}

model ApprovalDelegation {
  id              String   @id @default(cuid())
  fromRoleId      String
  toUserId        String
  
  // Delegation Period
  startDate       DateTime
  endDate         DateTime
  isActive        Boolean  @default(true)
  
  // Scope
  delegationType  String   // 'TEMPORARY' | 'PERMANENT' | 'EMERGENCY'
  reason          String
  maxAmount       Decimal? // Maximum amount that can be approved
  currency        String   @default("INR")
  
  // Usage Tracking
  usageCount      Int      @default(0)
  lastUsedAt      DateTime?
  
  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  fromRole        ApprovalRole @relation("FromRole", fields: [fromRoleId], references: [id])
  toUser          User     @relation("DelegatedToUser", fields: [toUserId], references: [id])
  
  @@index([fromRoleId])
  @@index([toUserId])
  @@index([isActive])
  @@index([startDate, endDate])
  @@index([delegationType])
}

model ApprovalNotification {
  id              String   @id @default(cuid())
  workflowId      String
  
  // Notification Details
  type            String   // 'APPROVAL_REQUIRED' | 'APPROVED' | 'REJECTED' | 'ESCALATED' | 'REMINDER'
  recipientId     String   // User ID to notify
  recipientRole   String?  // Role being notified
  
  // Message
  title           String
  message         String
  urgency         String   @default("NORMAL") // 'LOW' | 'NORMAL' | 'HIGH' | 'URGENT'
  
  // Delivery
  channels        String[] // ['EMAIL' | 'IN_APP' | 'SMS' | 'SLACK']
  emailSent       Boolean  @default(false)
  emailSentAt     DateTime?
  inAppRead       Boolean  @default(false)
  inAppReadAt     DateTime?
  
  // Scheduling
  scheduledFor    DateTime? // For scheduled notifications
  sentAt          DateTime?
  
  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  workflow        ApprovalWorkflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  
  @@index([workflowId])
  @@index([recipientId])
  @@index([type])
  @@index([emailSent])
  @@index([scheduledFor])
  @@index([urgency])
}

model ApprovalAuditLog {
  id              String   @id @default(cuid())
  workflowId      String?
  
  // Event Details
  event           String   // 'WORKFLOW_CREATED' | 'ACTION_TAKEN' | 'RULE_CHANGED' | 'DELEGATION_CREATED'
  entityType      String   // 'WORKFLOW' | 'RULE' | 'ROLE' | 'DELEGATION'
  entityId        String
  
  // Actor
  actorId         String   // User ID who performed action
  actorRole       String?  // Role of the actor
  
  // Changes
  oldValues       Json?    // Previous state
  newValues       Json?    // New state
  changeReason    String?
  
  // Context
  ipAddress       String?
  userAgent       String?
  sessionId       String?
  
  timestamp       DateTime @default(now())
  
  workflow        ApprovalWorkflow? @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  
  @@index([workflowId])
  @@index([event])
  @@index([entityType])
  @@index([actorId])
  @@index([timestamp])
  @@index([entityId])
}

// ============================================================================
// RCM (REVERSE CHARGE MECHANISM) MANAGEMENT MODELS
// ============================================================================

model RCMTransaction {
  id                String   @id @default(cuid())
  transactionType   String   // 'UNREGISTERED' | 'IMPORT_SERVICE' | 'NOTIFIED_SERVICE' | 'NOTIFIED_GOODS'
  
  // Reference Details
  purchaseInvoiceId String?
  purchaseInvoice   PurchaseInvoice? @relation(fields: [purchaseInvoiceId], references: [id])
  vendorId          String?
  vendor            Vendor? @relation(fields: [vendorId], references: [id])
  vendorName        String
  vendorGSTIN       String?
  vendorCountry     String?
  
  // Transaction Details
  invoiceNumber     String
  invoiceDate       DateTime
  description       String
  hsnSacCode        String
  
  // Amount Details
  taxableAmount     Decimal
  cgstAmount        Decimal?
  sgstAmount        Decimal?
  igstAmount        Decimal?
  cessAmount        Decimal?
  totalTaxAmount    Decimal
  
  // Currency (for imports)
  foreignCurrency   String?
  exchangeRate      Decimal?
  foreignAmount     Decimal?
  
  // Payment Status
  taxPaymentStatus  String   @default("PENDING") // 'PENDING' | 'PAID' | 'OVERDUE'
  paymentDueDate    DateTime
  paymentDate       DateTime?
  challanNumber     String?
  
  // ITC Details
  itcEligible       Boolean  @default(true)
  itcClaimed        Boolean  @default(false)
  itcClaimDate      DateTime?
  itcAmount         Decimal?
  
  // GSTR-3B Mapping
  returnPeriod      String   // MM-YYYY
  includedInReturn  Boolean  @default(false)
  
  // Audit
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  userId            String
  user              User     @relation(fields: [userId], references: [id])
  
  @@index([userId])
  @@index([taxPaymentStatus])
  @@index([paymentDueDate])
  @@index([returnPeriod])
  @@index([transactionType])
}

model ForeignSupplier {
  id              String   @id @default(cuid())
  userId          String
  name            String
  country         String
  serviceType     String   // 'SOFTWARE' | 'CONSULTING' | 'CLOUD' | 'OTHER'
  
  // Common Suppliers
  isKnownSupplier Boolean  @default(false)
  supplierCode    String?  // ADOBE, MICROSOFT, GOOGLE, AWS, etc.
  
  // Default Settings
  defaultHSN      String?
  defaultGSTRate  Decimal  @default(18)
  
  // Currency Settings
  defaultCurrency String   @default("USD")
  supportedCurrencies String[] @default(["USD"])
  
  // Service Categories
  serviceCategories String[] @default([])
  billingCountry  String?
  
  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, name, country])
  @@index([supplierCode])
  @@index([isKnownSupplier])
  @@index([serviceType])
  @@index([country])
}

model RCMRule {
  id              String   @id @default(cuid())
  ruleType        String   // 'SERVICE' | 'GOODS' | 'VENDOR_TYPE'
  category        String   // 'NOTIFIED' | 'IMPORT' | 'UNREGISTERED'
  
  // Identification Criteria
  hsnSacCodes     String[] // List of HSN/SAC codes
  description     String
  gstRate         Decimal
  
  // Conditions
  effectiveFrom   DateTime
  effectiveTo     DateTime?
  notificationNo  String?  // Government notification reference
  
  isActive        Boolean  @default(true)
  priority        Int      @default(0) // Higher number = higher priority
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([isActive, priority])
  @@index([ruleType, category])
}